/**
 * CodeGenerator - Generate ExScroller SDK code from model
 */

export class CodeGenerator {
  static generate(model) {
    const lines = [];

    // Header
    lines.push(`// Generated by ExScroller Studio 2`);
    lines.push(`// ${new Date().toISOString()}`);
    lines.push(``);
    lines.push(`const game = new Game({ title: '${model.title}' });`);
    lines.push(``);

    // Sprites
    if (model.sprites.size > 0) {
      lines.push(`// Sprites`);
      model.sprites.forEach(sprite => {
        lines.push(`game.defineSprite(${sprite.id}, ${sprite.width}, ${sprite.height}, new Uint8Array([`);
        lines.push(`  // sprite data here`);
        lines.push(`]));`);
      });
      lines.push(``);
    }

    // Sections
    model.sections.forEach(section => {
      lines.push(`// Section: ${section.name}`);
      lines.push(`game.section('${section.name}', {`);
      lines.push(`  feedMode: '${section.feedMode}',`);
      lines.push(`  speed: ${section.speed}`);
      lines.push(`})`);

      // Objects
      section.objects.forEach(obj => {
        const code = this.objectToCode(obj);
        if (code) {
          lines.push(`  ${code}`);
        }
      });

      lines.push(`  .feed(20);`);
      lines.push(``);
    });

    // Flow
    if (model.sections.length > 0) {
      const sectionNames = model.sections.map(s => `'${s.name}'`).join(', ');
      lines.push(`game.setFlow(${sectionNames});`);
      lines.push(``);
    }

    lines.push(`return game;`);

    return lines.join('\n');
  }

  static objectToCode(obj) {
    switch (obj.type) {
      case 'text':
        return `.text(${Math.round(obj.x)}, '${this.escapeString(obj.text)}', { size: ${this.pxToMm(obj.fontSize)} })`;

      case 'rect':
        return `.rect(${Math.round(obj.x)}, ${Math.round(obj.width)}, ${Math.round(obj.height)}, ${obj.fill ? 1 : 0})`;

      case 'circle':
        // Circle needs to be drawn with canvas, represented as comment
        return `// circle at (${Math.round(obj.x)}, ${Math.round(obj.y)}) r=${Math.round(obj.radius)}`;

      case 'line':
        // Line needs custom drawing
        return `// line from (${obj.points[0]}, ${obj.points[1]}) to (${obj.points[2]}, ${obj.points[3]})`;

      case 'sprite':
        return `.sprite(${obj.spriteId}, ${Math.round(obj.x)}, ${Math.round(obj.y)})`;

      case 'image':
        return `// image at (${Math.round(obj.x)}, ${Math.round(obj.y)}) ${obj.width}x${obj.height}`;

      default:
        return null;
    }
  }

  static escapeString(str) {
    return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/\n/g, '\\n');
  }

  static pxToMm(px) {
    // Approximate: 8 dots per mm
    return Math.round(px / 8 * 10) / 10;
  }
}
